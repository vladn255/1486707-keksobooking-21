(()=>{"use strict";(()=>{const e=document.querySelector("#error").content.querySelector(".error"),t=document.querySelector("#success").content.querySelector(".success"),o=(e,t)=>{let o=e+Math.random()*(t+1-e);return Math.floor(o)},r=e=>e[o(0,e.length-1)];window.util={KEY_ESCAPE:"Escape",KEY_ENTER:"Enter",generateRandomInt:o,getRandomSingleData:r,getRandomArrayData:e=>{let t=[],n=o(0,e.length-1);for(let o=0;o<=n;o++)t.push(r(e));return t},createErrorBlock:t=>{let o=e.cloneNode(!0);return o.querySelector(".error__message").textContent=t,o},removeErrorBlock:()=>{document.querySelector(".error").remove()},createSuccessBlock:()=>{let e=t.cloneNode(!0);e.classList.add("new__success"),document.body.insertAdjacentElement("afterbegin",e)},removeSuccessBlock:()=>{document.querySelector(".new__success").remove()}}})(),window.backend={load:(e,t)=>{let o=new XMLHttpRequest;o.responseType="json",o.addEventListener("load",(()=>{200===o.status?e(o.response):t("Статус ответа: "+o.status+" "+o.statusText)})),o.addEventListener("error",(function(){t("Произошла ошибка соединения")})),o.addEventListener("timeout",(function(){t("Запрос не успел выполниться за "+o.timeout+"мс")})),o.open("GET","https://21.javascript.pages.academy/keksobooking/data"),o.timeout=1e4,o.send()},save:(e,t,o)=>{let r=new XMLHttpRequest;r.responseType="json",r.addEventListener("load",(()=>{200===r.status?t(r.response):o("Статус ответа: "+r.status+" "+r.statusText)})),r.addEventListener("error",(function(){o("Произошла ошибка соединения")})),r.addEventListener("timeout",(function(){o("Запрос не успел выполниться за "+r.timeout+"мс")})),r.open("POST","https://21.javascript.pages.academy/keksobooking"),r.timeout=1e4,r.send(e)},debounce:e=>{let t=null;return(...o)=>{t&&window.clearTimeout(t),t=window.setTimeout((()=>{e(...o)}),500)}}},(()=>{const e=document.querySelector(".map"),t=e.querySelector("#housing-type"),o=e.querySelector("#housing-price"),r=e.querySelector("#housing-rooms"),n=e.querySelector("#housing-guests"),i=e.querySelector("#housing-features");let s=[];const d=e=>{document.querySelector(".error")&&(document.querySelector(".error__button").removeEventListener("click",window.backend.load(d,c)),window.util.removeErrorBlock()),s=e.slice()},a=e=>{0!==e.button&&e.key!==window.util.KEY_ESCAPE||window.backend.load(d,c)},c=e=>{document.querySelector(".error")&&window.util.removeErrorBlock(),document.body.insertAdjacentElement("afterbegin",window.util.createErrorBlock(e)),document.querySelector(".error__button").addEventListener("mousedown",a),document.addEventListener("click",a),document.addEventListener("keydown",a)},u=e=>{const o=t.value;return"any"===o||e.offer.type===o},l=e=>{const t=o.value;return"middle"===t?e.offer.price>=1e4&&e.offer.price<5e4:"low"===t?e.offer.price<1e4:"high"!==t||e.offer.price>=5e4},p=e=>{const t=r.value;return"any"===t||e.offer.rooms===parseInt(t,10)},m=e=>{const t=n.value;return"any"===t||e.offer.guests===parseInt(t,10)},w=(e,t)=>!i.querySelector("#filter-"+t).checked||e.offer.features.includes(t);window.backend.load(d,c),window.data={typesListPriceMin:{bungalow:0,flat:1e3,house:5e3,palace:1e4},errorHandler:c,filterPins:()=>{const e=[];for(let t=0;t<s.length&&5!==e.length;t++){let o=s[t];u(o)&&l(o)&&p(o)&&m(o)&&w(o,"wifi")&&w(o,"dishwasher")&&w(o,"parking")&&w(o,"washer")&&w(o,"elevator")&&w(o,"conditioner")&&e.push(o)}return e}}})(),(()=>{const e=document.querySelector("#pin").content.querySelector(".map__pin"),t=(t,o)=>{let r=e.cloneNode(!0);r.style.left=t.location.x-20+"px",r.style.top=t.location.y-40+"px";let n=r.querySelector("img");return n.src=t.author.avatar,n.alt=t.offer.title,r.dataset.id=o,r};window.pin={PIN_WIDTH:40,PIN_HEIGHT:40,PIN_MAIN_HEIGHT:44,PIN_QUANTITY:5,PIN_TAIL:18,createPinsFragment:()=>{const e=window.data.filterPins();let o=document.createDocumentFragment(),r=e.length<5?e.length:5;for(let n=0;n<r;n++)e[n].offer&&o.appendChild(t(e[n],n));return o}}})(),(()=>{const e=document.querySelector(".map__pins"),t=document.querySelector("#card").content,o={bungalow:"Бунгало",flat:"Квартира",house:"Дом",palace:"Дворец"},r=e=>{let t=document.createElement("li");return t.classList.add("popup__feature"),t.classList.add("popup__feature--"+e),t},n=e=>{let o=t.querySelector(".popup__photo").cloneNode(!0);return o.src=e,o};window.card={createPinsList:()=>{const t=window.pin.createPinsFragment();e.appendChild(t)},removePinsList:()=>{const t=e.querySelectorAll(".map__pin:not(.map__pin--main)");for(let e of t)e.remove()},renderCard:e=>{let i=document.querySelector(".map__card");var s;return i||(i=t.cloneNode(!0)),e.offer.address&&(i.querySelector(".popup__text--address").textContent=e.offer.address),e.offer.price&&(i.querySelector(".popup__text--price").textContent=e.offer.price),e.offer.type&&(i.querySelector(".popup__type").textContent=(s=e.offer.type,o[s])),e.offer.rooms&&e.offer.guests&&(i.querySelector(".popup__text--capacity").textContent=`${e.offer.rooms} комнаты для ${e.offer.guests} гостей`),e.offer.checkin&&e.offer.checkout&&(i.querySelector(".popup__text--time").textContent=`Заезд после ${e.offer.checkin}, выезд до ${e.offer.checkout}`),e.offer.features&&(i.querySelector(".popup__features").innerHTML="",i.querySelector(".popup__features").appendChild((e=>{let t=document.createDocumentFragment();for(let o of e)t.appendChild(r(o));return t})(e.offer.features))),e.offer.description&&(i.querySelector(".popup__description").textContent=e.offer.description),e.offer.photos&&(i.querySelector(".popup__photos").innerHTML="",i.querySelector(".popup__photos").appendChild((e=>{let t=document.createDocumentFragment();for(let o of e)t.appendChild(n(o));return t})(e.offer.photos))),e.author&&e.author.avatar&&(i.querySelector(".popup__avatar").src=e.author.avatar),i}}})(),(()=>{const e=window.pin.PIN_WIDTH,t=window.pin.PIN_HEIGHT,o=window.pin.PIN_TAIL,r=document.querySelector(".ad-form"),n=document.querySelector(".map"),i=document.querySelector(".map__filters"),s=r.querySelector("#capacity"),d=r.querySelector("#room_number"),a={adForm:r.querySelectorAll("fieldset"),mapFilter:i,mapFiltersFieldsets:i.querySelectorAll("fieldset"),mapFiltersSelects:i.querySelectorAll("select")},c=r.querySelector("#address"),u=r.querySelector("#title"),l=r.querySelector("#price"),p=r.querySelector("#type"),m=r.querySelector("#timein"),w=r.querySelector("#timeout"),f=r.querySelector("#description"),y=window.data.typesListPriceMin,v=(e,t)=>{for(let o of e)t?o.setAttribute("disabled",!0):o.removeAttribute("disabled")},_=()=>{v(a.adForm,!0),v(a.mapFilter,!0),v(a.mapFiltersFieldsets,!0),v(a.mapFiltersSelects,!0)};window.form={setDisabledAttribute:_,removeDisabledAttribute:()=>{v(a.adForm,!1),v(a.mapFilter,!1),v(a.mapFiltersFieldsets,!1),v(a.mapFiltersSelects,!1)},setAddressValue:(r,n=e/2,i=t/2)=>{let s=parseInt(r.style.left,10),d=parseInt(r.style.top,10);c.value=`${Math.round(s+n/2)}, ${Math.round(d+i+o)}`},onSetRooms:()=>{(()=>{let e=parseInt(d.value,10),t=parseInt(s.value,10);e<t&&100!==e?s.setCustomValidity("Количество гостей превышает допустимое для указанного количества комнат"):100===e&&0!==t?d.setCustomValidity("Такое количество комнат предназначено не для гостей"):100!==e&&0===t?s.setCustomValidity("Укажите количество комнат - 100"):(s.setCustomValidity(""),d.setCustomValidity(""))})(),s.reportValidity(),d.reportValidity()},onInputTitle:()=>{(()=>{const e=u.value.length;e<30?u.setCustomValidity("Минимальное количество символов - 30"):e>100?u.setCustomValidity("Максимальное количество символов - 100"):u.setCustomValidity("")})(),u.reportValidity()},onChangeType:()=>{(()=>{const e=y[p.value];l.setAttribute("placeholder",""+e)})(),p.reportValidity()},onInputPrice:()=>{(()=>{const e=parseInt(l.value,10),t=y[p.value];e<t?l.setCustomValidity("цена не может быть меньше "+t):e>1e6?l.setCustomValidity("цена не может быть больше 1000000"):l.setCustomValidity("")})(),l.reportValidity()},onSetTime:e=>{(e=>{const t=e.value;m.value!==w.value&&(m.value=t,w.value=t)})(e.currentTarget)},resetForm:()=>{_(),n.classList.add("map--faded"),r.classList.add("ad-form--disabled"),u.value="",l.value="",f.value="",i.reset()}}})(),(()=>{const e=document.querySelector(".map"),t=document.querySelector(".map__pins"),o=()=>{const e=t.querySelectorAll(".map__pin:not(.map__pin--main)");for(let t of e)t.addEventListener("click",r)},r=t=>{document.querySelector(".map__card")&&n();(t=>{const o=window.data.filterPins();if(0!==o.length){const n=o[t];r=window.card.renderCard(n),e.insertBefore(r,e.querySelector(".map__filters-container"));const s=document.querySelector(".map__card"),d=s.querySelector(".popup__close");s.classList.remove("visually-hidden"),d.addEventListener("click",i),e.addEventListener("keydown",i)}var r})(t.currentTarget.dataset.id)},n=()=>{document.querySelector(".map__card")&&document.querySelector(".map__card").classList.add("visually-hidden"),o()},i=e=>{0!==e.button&&e.key!==window.util.KEY_ESCAPE||n()};window.map={addShowCardListeners:o,closeCardPopup:n}})(),(()=>{const e=document.querySelector(".map__overlay"),t=document.querySelector(".map__pin--main"),o=window.pin.PIN_WIDTH,r=window.pin.PIN_HEIGHT,n=window.pin.PIN_TAIL,i=e.offsetTop+130,s=e.offsetTop+630,d=e.offsetLeft,a=e.offsetLeft+e.offsetWidth,c=parseInt(t.offsetLeft,10),u=parseInt(t.offsetTop,10);let l={x:0,y:0};window.move={onTraceMainPin:e=>{e.preventDefault(),l={x:e.clientX,y:e.clientY};const c=e=>{(e=>{e.preventDefault();let c=l.x-e.clientX,u=l.y-e.clientY;l.x=e.clientX,l.y=e.clientY;let p=t.offsetTop-u,m=t.offsetLeft-c;p<=i-r-n?p=i-r-n:p>=s-r-n&&(p=s-r-n),m<=d-o/2?m=d-o/2:m>=a-o/2&&(m=a-o/2),t.style.top=p+"px",t.style.left=m+"px"})(e),window.form.setAddressValue(t,o,r)},u=()=>{document.removeEventListener("mousemove",c),document.removeEventListener("mouseup",u)};document.addEventListener("mousemove",c),document.addEventListener("mouseup",u)},setInitialPosition:()=>{t.style.top=u+"px",t.style.left=c+"px"}}})(),(()=>{const e=window.pin.PIN_WIDTH,t=window.pin.PIN_MAIN_HEIGHT,o=document.querySelector(".map"),r=document.querySelector(".map__pin--main"),n=document.querySelector(".ad-form"),i=document.querySelector(".ad-form__reset"),s=o.querySelector("#housing-type"),d=o.querySelector("#housing-price"),a=o.querySelector("#housing-rooms"),c=o.querySelector("#housing-guests"),u=o.querySelector("#housing-features"),l=n.querySelector("#title"),p=n.querySelector("#price"),m=n.querySelector("#type"),w=n.querySelector("#timein"),f=n.querySelector("#timeout"),y=i=>{0!==i.button&&i.key!==window.util.KEY_ENTER||(window.card.createPinsList(window.pin.pinsFragment),window.map.addShowCardListeners(),o.classList.remove("map--faded"),n.classList.remove("ad-form--disabled"),window.form.removeDisabledAttribute(),window.form.setAddressValue(r,e,t),r.removeEventListener("mouseup",y),n.addEventListener("change",window.form.onSetRooms),l.addEventListener("input",window.form.onInputTitle),m.addEventListener("change",window.form.onChangeType),m.addEventListener("change",window.form.onInputPrice),p.addEventListener("input",window.form.onInputPrice),w.addEventListener("change",window.form.onSetTime),f.addEventListener("change",window.form.onSetTime),window.form.setAddressValue(r,e,t/2))},v=e=>{0!==e.button&&e.key!==window.util.KEY_ESCAPE||(window.util.removeSuccessBlock(),document.removeEventListener("click",v),document.removeEventListener("keydown",v))},_=()=>{r.addEventListener("mousedown",window.move.onTraceMainPin),r.addEventListener("mousedown",y),window.card.removePinsList(),window.form.resetForm(),window.move.setInitialPosition(),window.form.setAddressValue(r,e,t)},S=()=>{window.card.removePinsList(),window.data.filterPins(),window.card.createPinsList(window.pin.pinsFragment),window.map.closeCardPopup()};s.addEventListener("change",window.backend.debounce(S)),d.addEventListener("change",window.backend.debounce(S)),a.addEventListener("change",window.backend.debounce(S)),c.addEventListener("change",window.backend.debounce(S)),u.addEventListener("change",window.backend.debounce(S)),_(),n.addEventListener("submit",(e=>{e.preventDefault(),document.querySelector(".new__error")&&window.data.removeErrorBlock(),window.backend.save(new FormData(n),(()=>{window.util.createSuccessBlock(),r.removeEventListener("mousedown",window.move.onTraceMainPin),r.removeEventListener("mousedown",y),_(),document.addEventListener("click",v),document.addEventListener("keydown",v)}),window.data.errorHandler)})),i.addEventListener("click",_),window.form.setDisabledAttribute()})()})();