(()=>{"use strict";(()=>{const e=document.querySelector("#error").content.querySelector(".error"),t=document.querySelector("#success").content.querySelector(".success"),o=(e,t)=>{let o=e+Math.random()*(t+1-e);return Math.floor(o)},r=e=>e[o(0,e.length-1)];window.util={KEY_ESCAPE:"Escape",KEY_ENTER:"Enter",generateRandomInt:o,getRandomSingleData:r,getRandomArrayData:e=>{let t=[],n=o(0,e.length-1);for(let o=0;o<=n;o++)t.push(r(e));return t},createErrorBlock:t=>{let o=e.cloneNode(!0);return o.querySelector(".error__message").textContent=t,o},removeErrorBlock:()=>{document.querySelector(".error").remove()},createSuccessBlock:()=>{let e=t.cloneNode(!0);e.classList.add("new__success"),document.body.insertAdjacentElement("afterbegin",e)},removeSuccessBlock:()=>{document.querySelector(".new__success").remove()}}})(),(()=>{const e=(e,t,o)=>{200===e.status?t(e.response):o("Статус ответа: "+e.status+" "+e.statusText)};window.backend={load:(t,o)=>{let r=new XMLHttpRequest;r.responseType="json",r.addEventListener("load",(()=>{e(r,t,o)})),r.addEventListener("error",(()=>{o("Произошла ошибка соединения")})),r.addEventListener("timeout",(()=>{o("Запрос не успел выполниться за "+r.timeout+"мс")})),r.open("GET","https://21.javascript.pages.academy/keksobooking/data"),r.timeout=1e4,r.send()},save:(t,o,r)=>{let n=new XMLHttpRequest;n.responseType="json",n.addEventListener("load",(()=>{e(n,o,r)})),n.addEventListener("error",(()=>{r("Произошла ошибка соединения")})),n.addEventListener("timeout",(()=>{r("Запрос не успел выполниться за "+n.timeout+"мс")})),n.open("POST","https://21.javascript.pages.academy/keksobooking"),n.timeout=1e4,n.send(t)},debounce:e=>{let t=null;return(...o)=>{t&&window.clearTimeout(t),t=window.setTimeout((()=>{e(...o)}),500)}}}})(),(()=>{const e=document.querySelector(".map"),t=e.querySelector("#housing-type"),o=e.querySelector("#housing-price"),r=e.querySelector("#housing-rooms"),n=e.querySelector("#housing-guests"),i=e.querySelector("#housing-features");let a=[];const d=e=>{document.querySelector(".error")&&(document.querySelector(".error__button").removeEventListener("click",window.backend.load(d,c)),window.util.removeErrorBlock()),a=e.slice()},s=e=>{0!==e.button&&e.key!==window.util.KEY_ESCAPE||window.backend.load(d,c)},c=e=>{document.querySelector(".error")&&window.util.removeErrorBlock(),document.body.insertAdjacentElement("afterbegin",window.util.createErrorBlock(e)),document.querySelector(".error__button").addEventListener("mousedown",s),document.addEventListener("click",s),document.addEventListener("keydown",s)},u=e=>{const o=t.value;return"any"===o||e.offer.type===o},l=e=>{const t=o.value;return"middle"===t?e.offer.price>=1e4&&e.offer.price<5e4:"low"===t?e.offer.price<1e4:"high"!==t||e.offer.price>=5e4},m=e=>{const t=r.value;return"any"===t||e.offer.rooms===parseInt(t,10)},p=e=>{const t=n.value;return"any"===t||e.offer.guests===parseInt(t,10)},f=(e,t)=>!i.querySelector("#filter-"+t).checked||e.offer.features.includes(t);window.backend.load(d,c),window.data={typesListPriceMin:{bungalow:0,flat:1e3,house:5e3,palace:1e4},onError:c,filterPins:()=>{const e=[];for(let t=0;t<a.length&&5!==e.length;t++){let o=a[t];u(o)&&l(o)&&m(o)&&p(o)&&f(o,"wifi")&&f(o,"dishwasher")&&f(o,"parking")&&f(o,"washer")&&f(o,"elevator")&&f(o,"conditioner")&&e.push(o)}return e}}})(),(()=>{const e=document.querySelector(".map__pin--main").offsetWidth,t=document.querySelector(".map__pin--main").offsetHeight,o=document.querySelector("#pin").content.querySelector(".map__pin"),r=(r,n)=>{let i=o.cloneNode(!0);i.style.left=r.location.x-e/2+"px",i.style.top=r.location.y-t+"px";let a=i.querySelector("img");return a.src=r.author.avatar,a.alt=r.offer.title,i.dataset.id=n,i};window.pin={PIN_WIDTH:e,PIN_HEIGHT:t,PIN_QUANTITY:5,PIN_TAIL:18,createPinsFragment:()=>{const e=window.data.filterPins();let t=document.createDocumentFragment(),o=e.length<5?e.length:5;for(let n=0;n<o;n++)e[n].offer&&t.appendChild(r(e[n],n));return t}}})(),(()=>{const e=document.querySelector(".map__pins"),t=document.querySelector("#card").content,o={bungalow:"Бунгало",flat:"Квартира",house:"Дом",palace:"Дворец"},r=e=>{let t=document.createElement("li");return t.classList.add("popup__feature"),t.classList.add("popup__feature--"+e),t},n=e=>{let o=t.querySelector(".popup__photo").cloneNode(!0);return o.src=e,o};window.card={createPinsList:()=>{const t=window.pin.createPinsFragment();e.appendChild(t)},removePinsList:()=>{const t=e.querySelectorAll(".map__pin:not(.map__pin--main)");for(let e of t)e.remove()},renderCard:e=>{let i=document.querySelector(".map__card");var a;return i||(i=t.cloneNode(!0)),e.offer.address&&(i.querySelector(".popup__text--address").textContent=e.offer.address),e.offer.price&&(i.querySelector(".popup__text--price").textContent=e.offer.price),e.offer.type&&(i.querySelector(".popup__type").textContent=(a=e.offer.type,o[a])),e.offer.rooms&&e.offer.guests&&(i.querySelector(".popup__text--capacity").textContent=`${e.offer.rooms} комнаты для ${e.offer.guests} гостей`),e.offer.checkin&&e.offer.checkout&&(i.querySelector(".popup__text--time").textContent=`Заезд после ${e.offer.checkin}, выезд до ${e.offer.checkout}`),e.offer.features&&(i.querySelector(".popup__features").innerHTML="",i.querySelector(".popup__features").appendChild((e=>{let t=document.createDocumentFragment();for(let o of e)t.appendChild(r(o));return t})(e.offer.features))),e.offer.description&&(i.querySelector(".popup__description").textContent=e.offer.description),e.offer.photos&&(i.querySelector(".popup__photos").innerHTML="",i.querySelector(".popup__photos").appendChild((e=>{let t=document.createDocumentFragment();for(let o of e)t.appendChild(n(o));return t})(e.offer.photos))),e.author&&e.author.avatar&&(i.querySelector(".popup__avatar").src=e.author.avatar),i}}})(),(()=>{const e=window.pin.PIN_WIDTH,t=window.pin.PIN_HEIGHT,o=window.pin.PIN_TAIL,r=document.querySelector(".ad-form"),n=document.querySelector(".map"),i=document.querySelector(".map__filters"),a=r.querySelector("#capacity"),d=r.querySelector("#room_number"),s=r.querySelector("#address"),c=r.querySelector("#title"),u=r.querySelector("#price"),l=r.querySelector("#type"),m=r.querySelector("#timein"),p=r.querySelector("#timeout"),f=window.data.typesListPriceMin,y={adForm:r.querySelectorAll("fieldset"),mapFilter:i,mapFiltersFieldsets:i.querySelectorAll("fieldset"),mapFiltersSelects:i.querySelectorAll("select")},w=(e,t)=>{for(let o of e)t?o.setAttribute("disabled",!0):o.removeAttribute("disabled")},_=()=>{w(y.adForm,!0),w(y.mapFilter,!0),w(y.mapFiltersFieldsets,!0),w(y.mapFiltersSelects,!0)};window.form={setDisabledAttribute:_,removeDisabledAttribute:()=>{w(y.adForm,!1),w(y.mapFilter,!1),w(y.mapFiltersFieldsets,!1),w(y.mapFiltersSelects,!1)},setAddressValue:(r,n=e/2,i=t/2)=>{let a=parseInt(r.style.left,10),d=parseInt(r.style.top,10);s.value=`${Math.round(a+n/2)}, ${Math.round(d+i+o)}`},onSetRooms:()=>{(()=>{let e=parseInt(d.value,10),t=parseInt(a.value,10);e<t&&100!==e?a.setCustomValidity("Количество гостей превышает допустимое для указанного количества комнат"):100===e&&0!==t?d.setCustomValidity("Такое количество комнат предназначено не для гостей"):100!==e&&0===t?a.setCustomValidity("Укажите количество комнат - 100"):(a.setCustomValidity(""),d.setCustomValidity(""))})(),a.reportValidity(),d.reportValidity()},onInputTitle:()=>{(()=>{const e=c.value.length;e<30?c.setCustomValidity("Минимальное количество символов - 30"):e>100?c.setCustomValidity("Максимальное количество символов - 100"):c.setCustomValidity("")})(),c.reportValidity()},onChangeType:()=>{(()=>{const e=f[l.value];u.setAttribute("placeholder",""+e)})(),l.reportValidity()},onInputPrice:()=>{(()=>{const e=parseInt(u.value,10),t=f[l.value];e<t?u.setCustomValidity("цена не может быть меньше "+t):e>1e6?u.setCustomValidity("цена не может быть больше 1000000"):u.setCustomValidity("")})(),u.reportValidity()},onSetTime:e=>{(e=>{const t=e.value;m.value!==p.value&&(m.value=t,p.value=t)})(e.currentTarget)},resetForm:()=>{_(),n.classList.add("map--faded"),r.classList.add("ad-form--disabled"),r.reset(),i.reset()}}})(),(()=>{const e=document.querySelector(".map"),t=document.querySelector(".map__pins"),o=()=>{const e=t.querySelectorAll(".map__pin:not(.map__pin--main)");for(let t of e)t.addEventListener("click",r)},r=t=>{document.querySelector(".map__card")&&n();(t=>{const o=window.data.filterPins();if(0!==o.length){const n=o[t];r=window.card.renderCard(n),e.insertBefore(r,e.querySelector(".map__filters-container"));const a=document.querySelector(".map__card"),d=a.querySelector(".popup__close");a.classList.remove("visually-hidden"),d.addEventListener("click",i),e.addEventListener("keydown",i)}var r})(t.currentTarget.dataset.id),t.currentTarget.classList.add("map__pin--active")},n=()=>{if(document.querySelector(".map__card")){document.querySelector(".map__card").classList.add("visually-hidden");const e=document.querySelector(".map__pin--active");e&&e.classList.remove("map__pin--active")}},i=e=>{0!==e.button&&e.key!==window.util.KEY_ESCAPE||(n(),o())};window.map={addShowCardListeners:o,closeCardPopup:n}})(),(()=>{const e=document.querySelector(".map__pin--main").offsetWidth,t=document.querySelector(".map__pin--main").offsetHeight,o=window.pin.PIN_TAIL,r=document.querySelector(".map__overlay").offsetTop+130,n=document.querySelector(".map__overlay").offsetTop+630,i=document.querySelector(".map__overlay").offsetLeft,a=document.querySelector(".map__overlay").offsetLeft+document.querySelector(".map__overlay").offsetWidth,d=parseInt(document.querySelector(".map__pin--main").offsetLeft,10),s=parseInt(document.querySelector(".map__pin--main").offsetTop,10),c=document.querySelector(".map__pin--main");let u={x:0,y:0};window.move={onTraceMainPin:d=>{d.preventDefault(),u={x:d.clientX,y:d.clientY};const s=d=>{(d=>{d.preventDefault();let s=u.x-d.clientX,l=u.y-d.clientY;u.x=d.clientX,u.y=d.clientY;let m=c.offsetTop-l,p=c.offsetLeft-s;m<=r-t-o?m=r-t-o:m>=n-t-o&&(m=n-t-o),p<=i-e/2?p=i-e/2:p>=a-e/2&&(p=a-e/2),c.style.top=m+"px",c.style.left=p+"px"})(d),window.form.setAddressValue(c,e,t)},l=()=>{document.removeEventListener("mousemove",s),document.removeEventListener("mouseup",l)};document.addEventListener("mousemove",s),document.addEventListener("mouseup",l)},setInitialPosition:()=>{c.style.top=s+"px",c.style.left=d+"px"}}})(),(()=>{const e=["gif","jpg","jpeg","png"],t=document.querySelector(".ad-form-header__input"),o=document.querySelector(".ad-form-header__preview").querySelector("img"),r=document.querySelector(".ad-form__input"),n=document.querySelector(".ad-form__photo"),i=(t,o)=>{const r=t.files[0],n=r.name.toLowerCase();if(e.some((e=>n.endsWith(e)))){const e=new FileReader;e.addEventListener("load",(()=>{"img"!==o.tagName.toLowerCase()&&(o.style.backgroundImage=`url(${e.result})`,o.style.backgroundRepeat="round"),o.src=e.result})),e.readAsDataURL(r)}};t.addEventListener("change",(()=>{i(t,o)})),r.addEventListener("change",(()=>{i(r,n)}))})(),(()=>{const e=document.querySelector(".map__pin--main").offsetWidth,t=document.querySelector(".map__pin--main").offsetHeight,o=document.querySelector(".map"),r=document.querySelector(".map__pin--main"),n=document.querySelector(".ad-form"),i=document.querySelector(".ad-form__reset"),a=o.querySelector("#housing-type"),d=o.querySelector("#housing-price"),s=o.querySelector("#housing-rooms"),c=o.querySelector("#housing-guests"),u=o.querySelector("#housing-features"),l=n.querySelector("#title"),m=n.querySelector("#price"),p=n.querySelector("#type"),f=n.querySelector("#timein"),y=n.querySelector("#timeout"),w=i=>{0!==i.button&&i.key!==window.util.KEY_ENTER||(window.card.createPinsList(window.pin.pinsFragment),window.map.addShowCardListeners(),o.classList.remove("map--faded"),n.classList.remove("ad-form--disabled"),window.form.removeDisabledAttribute(),window.form.setAddressValue(r,e,t),r.removeEventListener("mouseup",w),r.removeEventListener("keydown",w),n.addEventListener("change",window.form.onSetRooms),l.addEventListener("input",window.form.onInputTitle),p.addEventListener("change",window.form.onChangeType),p.addEventListener("change",window.form.onInputPrice),m.addEventListener("input",window.form.onInputPrice),f.addEventListener("change",window.form.onSetTime),y.addEventListener("change",window.form.onSetTime),window.form.setAddressValue(r,e,t/2))},_=e=>{0!==e.button&&e.key!==window.util.KEY_ESCAPE||(window.util.removeSuccessBlock(),document.removeEventListener("click",_),document.removeEventListener("keydown",_))},v=()=>{r.addEventListener("mousedown",window.move.onTraceMainPin),r.addEventListener("mousedown",w),r.addEventListener("keydown",w),window.card.removePinsList(),window.form.resetForm(),window.move.setInitialPosition(),window.form.setAddressValue(r,e,t),window.map.closeCardPopup()},S=()=>{window.card.removePinsList(),window.data.filterPins(),window.card.createPinsList(window.pin.pinsFragment),window.map.addShowCardListeners(),window.map.closeCardPopup()};a.addEventListener("change",window.backend.debounce(S)),d.addEventListener("change",window.backend.debounce(S)),s.addEventListener("change",window.backend.debounce(S)),c.addEventListener("change",window.backend.debounce(S)),u.addEventListener("change",window.backend.debounce(S)),v(),n.addEventListener("submit",(e=>{e.preventDefault(),document.querySelector(".new__error")&&window.data.removeErrorBlock(),window.backend.save(new FormData(n),(()=>{window.util.createSuccessBlock(),r.removeEventListener("mousedown",window.move.onTraceMainPin),r.removeEventListener("mousedown",w),r.removeEventListener("keydown",w),v(),document.addEventListener("click",_),document.addEventListener("keydown",_)}),window.data.onError)})),i.addEventListener("click",v),window.form.setDisabledAttribute()})()})();